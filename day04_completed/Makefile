# Makefile for Day 04 Completed - Cãƒ™ãƒ¼ã‚¹ã®ã‚·ãƒªã‚¢ãƒ« + VGAï¼ˆbootåˆ†å‰²ï¼‰

AS   = nasm
CC   = i686-elf-gcc
LD   = i686-elf-ld
OBJCOPY = i686-elf-objcopy
QEMU = qemu-system-i386

CFLAGS = -ffreestanding -m32 -nostdlib -fno-stack-protector -fno-pic -O2 -Wall -Wextra

BOOT    = boot/boot.s
ENTRY   = boot/kernel_entry.s
KERNELC = kernel.c

BOOTBIN = boot.bin
KELF    = kernel.elf
KBIN    = kernel.bin
OS_IMG  = os.img

all: $(OS_IMG)
	@echo "âœ… Day 04 Completed: Cãƒ™ãƒ¼ã‚¹æ§‹æˆã§ãƒ“ãƒ«ãƒ‰å®Œäº†"
	@echo "ğŸš€ å®Ÿè¡Œ: make run  ï¼ˆã‚·ãƒªã‚¢ãƒ«ã¯ç«¯æœ«ã«è¡¨ç¤ºã•ã‚Œã¾ã™ï¼‰"

$(BOOTBIN): $(BOOT)
	$(AS) -f bin $(BOOT) -o $(BOOTBIN)

kernel_entry.o: $(ENTRY)
	$(AS) -f elf32 $(ENTRY) -o $@

kernel.o: $(KERNELC) vga.h io.h
	$(CC) $(CFLAGS) -c $(KERNELC) -o $@

$(KELF): kernel_entry.o kernel.o
	$(LD) -m elf_i386 -Ttext 0x00010000 -e kernel_entry -o $(KELF) kernel_entry.o kernel.o

$(KBIN): $(KELF)
	$(OBJCOPY) -O binary $(KELF) $(KBIN)

$(OS_IMG): $(BOOTBIN) $(KBIN)
	cat $(BOOTBIN) $(KBIN) > $(OS_IMG)
	truncate -s 1440K $(OS_IMG)

run: $(OS_IMG)
	@echo "ğŸš€ QEMUã§èµ·å‹•ï¼ˆ-serial stdioï¼‰..."
	$(QEMU) -fda $(OS_IMG) -boot a -serial stdio

debug: $(OS_IMG)
	@echo "ğŸ” ãƒ¢ãƒ‹ã‚¿ä»˜ãã§èµ·å‹•..."
	$(QEMU) -fda $(OS_IMG) -boot a -serial stdio -monitor tcp:127.0.0.1:4444,server,nowait

clean:
	@echo "ğŸ§¹ ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—..."
	rm -f $(BOOTBIN) kernel_entry.o kernel.o $(KELF) $(KBIN) $(OS_IMG)
	@echo "âœ… å®Œäº†"

.PHONY: all run debug clean
